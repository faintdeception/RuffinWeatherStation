@page "/weather-home"
@page "/home"
@using System.Net.Http.Json
@inject TemperatureService TemperatureService

<h1>Current Weather Dashboard</h1>

@if (prediction != null)
{
    <div class="alert alert-info mb-4">
        <div class="d-flex align-items-start">
            <div style="font-size: 2rem; margin-right: 15px;">ðŸ¤–</div>
            <div>
                <h5 class="alert-heading">Weather Prediction</h5>
                <p class="mb-0">@prediction.Reasoning</p>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <small class="text-muted">Created: @prediction.CreatedAt | Confidence: @prediction.ConfidencePercentage</small>
                    <button class="btn btn-sm btn-outline-primary" @onclick="RefreshPrediction">
                        <span class="oi oi-reload" aria-hidden="true"></span> Update
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <p>Real-time weather data from the Ruffin Weather Station</p>
    
    <button class="btn btn-primary" @onclick="RefreshData" disabled="@isLoading">
        @if (isLoading)
        {
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <span class="ms-1">Refreshing...</span>
        }
        else
        {
            <span class="oi oi-reload" aria-hidden="true"></span>
            <span class="ms-1">Refresh Data</span>
        }
    </button>
</div>

@if (isLoading && measurement?.Fields == null)
{
    <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading weather data...</p>
    </div>
}
else if (measurement == null)
{
    <div class="alert alert-warning" role="alert">
        No weather data available. Please try refreshing.
    </div>
}
else
{
    <div class="row">
        <div class="col-md-4">
            <div class="card" style="max-width: 400px;">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">Temperature</h3>
                        <div>
                            <span class="badge @(IsDataStale() ? "bg-warning" : "bg-success")">
                                @(IsDataStale() ? "Data may be stale" : "Data current")
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="display-1 text-center">@FormatDouble(measurement.Fields?.Temperature)Â°C</div>
                    <div class="h4 text-center">@FormatTemperatureF(measurement.Fields?.Temperature)Â°F</div>
                    <p class="text-center text-muted">
                        Last updated: @measurement.TimestampStr
                        @if (cacheStatus != null)
                        {
                            <span class="badge bg-info ms-2">@cacheStatus</span>
                        }
                        @if (IsDataStale())
                        {
                            <span class="text-warning d-block">Data is @GetDataAge() old</span>
                        }
                        @if (nextCacheRefresh.HasValue)
                        {
                            <small class="d-block mt-1">Next data refresh in approximately @GetTimeUntilCacheRefresh()</small>
                        }
                    </p>
                    <hr />
                    <table class="table table-sm">
                        <tr><th>Humidity</th><td>@FormatDouble(measurement.Fields?.Humidity)%</td></tr>
                        <tr><th>Dewpoint</th><td>@FormatDouble(measurement.Fields?.Dewpoint)Â°C</td></tr>
                        <tr><th>Pressure</th><td>@FormatDouble(measurement.Fields?.Pressure) hPa</td></tr>
                        <tr><th>Light</th><td>@FormatDouble(measurement.Fields?.Lux) lux</td></tr>
                        <tr><th>Wind</th><td>@FormatDouble(measurement.Fields?.WindSpeed) m/s (@measurement.Fields?.WindDirectionCardinal)</td></tr>
                        <tr><th>Rain</th><td>@FormatDouble(measurement.Fields?.Rain) mm</td></tr>
                        <tr><th>Location</th><td>@measurement.Tags?.Location</td></tr>
                        <tr><th>Sensor</th><td>@measurement.Tags?.SensorType</td></tr>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            @if (showShortTermAnalysis)
            {
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="mb-0">Recent Weather Analysis</h3>
                            <div>
                                <button @onclick="() => AnalyzeRecentPeriod(1)" class="btn btn-outline-light @(analysisHours == 1 ? "active" : "")">1 Hour</button>
                                <button @onclick="() => AnalyzeRecentPeriod(6)" class="btn btn-outline-light @(analysisHours == 6 ? "active" : "")">6 Hours</button>
                                <button @onclick="() => AnalyzeRecentPeriod(12)" class="btn btn-outline-light @(analysisHours == 12 ? "active" : "")">12 Hours</button>
                                <button @onclick="() => AnalyzeRecentPeriod(24)" class="btn btn-outline-light @(analysisHours == 24 ? "active" : "")">24 Hours</button>
                                <button @onclick="SwitchToLongTermAnalysis" class="btn btn-outline-light ms-2">Long-term</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (IsDeviceOffline())
                        {
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> 
                                Warning: Weather station appears to be offline. Data shown may not be current.
                            </div>
                        }
                        
                        @if (recentAnalysisResult == null || !recentAnalysisResult.Success)
                        {
                            <p><em>Loading analysis data...</em></p>
                            @if (recentAnalysisResult?.ErrorMessage != null)
                            {
                                <div class="alert alert-warning">@recentAnalysisResult.ErrorMessage</div>
                            }
                        }
                        else
                        {
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <strong>Analysis Period:</strong> @recentAnalysisResult.StartDate.ToString("g") to @recentAnalysisResult.EndDate.ToString("g")
                                        <br/>
                                        <strong>Measurements:</strong> @recentAnalysisResult.MeasurementCount data points (avg. @recentAnalysisResult.SampleRate min between samples)
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h5>Temperature</h5>
                                            <div class="display-6">@FormatDouble(recentAnalysisResult.AverageTemperature)Â°C</div>
                                            <div>High: @FormatDouble(recentAnalysisResult.HighestTemperature)Â°C</div>
                                            <div>Low: @FormatDouble(recentAnalysisResult.LowestTemperature)Â°C</div>
                                            <div class="mt-2">
                                                @if (recentAnalysisResult.TemperatureTrend > 0.1)
                                                {
                                                    <span class="badge bg-danger">Rising (@FormatDouble(recentAnalysisResult.TemperatureTrend)Â°C)</span>
                                                }
                                                else if (recentAnalysisResult.TemperatureTrend < -0.1)
                                                {
                                                    <span class="badge bg-info">Falling (@FormatDouble(Math.Abs(recentAnalysisResult.TemperatureTrend))Â°C)</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">Stable</span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h5>Pressure</h5>
                                            <div class="display-6">@FormatDouble(recentAnalysisResult.AveragePressure) hPa</div>
                                            <div>High: @FormatDouble(recentAnalysisResult.HighestPressure) hPa</div>
                                            <div>Low: @FormatDouble(recentAnalysisResult.LowestPressure) hPa</div>
                                            <div class="mt-2">
                                                @if (recentAnalysisResult.PressureTrend > 0.5)
                                                {
                                                    <span class="badge bg-warning">Rising (@FormatDouble(recentAnalysisResult.PressureTrend) hPa)</span>
                                                }
                                                else if (recentAnalysisResult.PressureTrend < -0.5)
                                                {
                                                    <span class="badge bg-primary">Falling (@FormatDouble(Math.Abs(recentAnalysisResult.PressureTrend)) hPa)</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">Stable</span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h5>Rainfall</h5>
                                            <div class="display-6">@FormatDouble(recentAnalysisResult.TotalRainfall) mm</div>
                                            <div>Over the last @analysisHours hour(s)</div>
                                            @if (recentAnalysisResult.TotalRainfall > 0)
                                            {
                                                <div class="mt-2">
                                                    <span class="badge bg-primary">Precipitation detected</span>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="mt-2">
                                                    <span class="badge bg-secondary">No rain</span>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <h4>Temperature Trend (Last @analysisHours hour@(analysisHours == 1 ? "" : "s"))</h4>
                            <div class="mb-4">
                                @if (recentAnalysisResult.HourlyTemperatures != null && recentAnalysisResult.HourlyTemperatures.Any())
                                {
                                    <RadzenChart>
                                        <RadzenLineSeries Smooth="true" Data="@recentAnalysisResult.HourlyTemperatures" 
                                                        CategoryProperty="Timestamp" 
                                                        ValueProperty="Temperature" 
                                                        Title="Temperature (Â°C)" 
                                                        LineType="LineType.Solid"
                                                        StrokeWidth="3">
                                            <RadzenMarkers MarkerType="MarkerType.Circle" Size="4" />
                                        </RadzenLineSeries>
                                        <RadzenCategoryAxis Formatter="@FormatTimestamp"></RadzenCategoryAxis>
                                        <RadzenValueAxis>
                                            <RadzenGridLines Visible="true" />
                                            <RadzenAxisTitle Text="Temperature (Â°C)" />
                                        </RadzenValueAxis>
                                        <RadzenLegend Position="LegendPosition.Top" />
                                    </RadzenChart>
                                }
                                else
                                {
                                    <p>No temperature data available for this period.</p>
                                }
                            </div>
                            
                            <h4>Pressure Trend (Last @analysisHours hour@(analysisHours == 1 ? "" : "s"))</h4>
                            <div class="mb-4">
                                @if (recentAnalysisResult.HourlyPressures != null && recentAnalysisResult.HourlyPressures.Any())
                                {
                                    <RadzenChart>
                                        <RadzenLineSeries Smooth="true" Data="@recentAnalysisResult.HourlyPressures" 
                                                        CategoryProperty="Timestamp" 
                                                        ValueProperty="Value" 
                                                        Title="Pressure (hPa)" 
                                                        StrokeWidth="3">
                                            <RadzenMarkers MarkerType="MarkerType.Circle" Size="4" />
                                        </RadzenLineSeries>
                                        <RadzenCategoryAxis Formatter="@FormatTimestamp"></RadzenCategoryAxis>
                                        <RadzenValueAxis>
                                            <RadzenGridLines Visible="true" />
                                            <RadzenAxisTitle Text="Pressure (hPa)" />
                                        </RadzenValueAxis>
                                    </RadzenChart>
                                }
                                else
                                {
                                    <p>No pressure data available for this period.</p>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="mb-0">Long-term Weather Analysis</h3>
                            <div>
                                <button @onclick="() => AnalyzePeriod(7)" class="btn btn-outline-light @(analysisPeriod == 7 ? "active" : "")">7 Days</button>
                                <button @onclick="() => AnalyzePeriod(14)" class="btn btn-outline-light @(analysisPeriod == 14 ? "active" : "")">14 Days</button>
                                <button @onclick="() => AnalyzePeriod(30)" class="btn btn-outline-light @(analysisPeriod == 30 ? "active" : "")">30 Days</button>
                                <button @onclick="SwitchToShortTermAnalysis" class="btn btn-outline-light ms-2">Recent</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (analysisResult == null || !analysisResult.Success)
                        {
                            <p><em>Loading analysis data...</em></p>
                            @if (analysisResult?.ErrorMessage != null)
                            {
                                <div class="alert alert-warning">@analysisResult.ErrorMessage</div>
                            }
                        }
                        else
                        {
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h5>Temperature</h5>
                                            <div class="display-6">@FormatDouble(analysisResult.AverageTemperature)Â°C</div>
                                            <div>High: @FormatDouble(analysisResult.HighestTemperature)Â°C</div>
                                            <div>Low: @FormatDouble(analysisResult.LowestTemperature)Â°C</div>
                                            <div class="mt-2">
                                                @if (analysisResult.TemperatureTrend > 0.2)
                                                {
                                                    <span class="badge bg-danger">Warming trend</span>
                                                }
                                                else if (analysisResult.TemperatureTrend < -0.2)
                                                {
                                                    <span class="badge bg-info">Cooling trend</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">Stable</span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h5>Pressure</h5>
                                            <div class="display-6">@FormatDouble(analysisResult.AveragePressure) hPa</div>
                                            <div>High: @FormatDouble(analysisResult.HighestPressure) hPa</div>
                                            <div>Low: @FormatDouble(analysisResult.LowestPressure) hPa</div>
                                            <div class="mt-2">
                                                @if (analysisResult.PressureTrend > 1)
                                                {
                                                    <span class="badge bg-warning">Rising pressure</span>
                                                }
                                                else if (analysisResult.PressureTrend < -1)
                                                {
                                                    <span class="badge bg-primary">Falling pressure</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">Stable</span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h5>Rainfall</h5>
                                            <div class="display-6">@FormatDouble(analysisResult.TotalRainfall) mm</div>
                                            <div>Rainy Days: @analysisResult.RainyDaysCount</div>
                                            <div>Analysis Period: @analysisResult.StartDate.ToString("MMM d") - @analysisResult.EndDate.ToString("MMM d")</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <h4>Temperature Trends</h4>
                            <div class="mb-4">
                                @if (analysisResult.HourlyTemperatures != null && analysisResult.HourlyTemperatures.Any())
                                {
                                    <RadzenChart>
                                        <RadzenAreaSeries Smooth="true" Data="@analysisResult.HourlyTemperatures" 
                                                        CategoryProperty="Timestamp" 
                                                        ValueProperty="Temperature" 
                                                        Title="Temperature (Â°C)" 
                                                        Fill="rgba(54, 162, 235, 0.2)">
                                    </RadzenAreaSeries>
                                    <RadzenLineSeries Smooth="true" Data="@analysisResult.HourlyTemperatures" 
                                                        CategoryProperty="Timestamp" 
                                                        ValueProperty="Max" 
                                                        Title="Maximum (Â°C)" 
                                                        LineType="LineType.Dashed">
                                    </RadzenLineSeries>
                                    <RadzenLineSeries Smooth="true" Data="@analysisResult.HourlyTemperatures" 
                                                        CategoryProperty="Timestamp" 
                                                        ValueProperty="Min" 
                                                        Title="Minimum (Â°C)" 
                                                        LineType="LineType.Dashed">
                                    </RadzenLineSeries>
                                    <RadzenCategoryAxis Formatter="@FormatTimestamp"></RadzenCategoryAxis>
                                    <RadzenValueAxis>
                                        <RadzenGridLines Visible="true" />
                                        <RadzenAxisTitle Text="Temperature (Â°C)" />
                                    </RadzenValueAxis>
                                    <RadzenLegend Position="LegendPosition.Top" />
                                </RadzenChart>
                                }
                                else
                                {
                                    <p>No temperature trend data available for this period.</p>
                                }
                            </div>
                            
                            <h4>Pressure Trends</h4>
                            <div class="mb-4">
                                @if (analysisResult.HourlyPressures != null && analysisResult.HourlyPressures.Any())
                                {
                                    <RadzenChart>
                                        <RadzenLineSeries Smooth="true" Data="@analysisResult.HourlyPressures" 
                                                        CategoryProperty="Timestamp" 
                                                        ValueProperty="Value" 
                                                        Title="Pressure (hPa)" 
                                                        StrokeWidth="3">
                                            <RadzenMarkers MarkerType="MarkerType.Circle" Size="4" />
                                        </RadzenLineSeries>
                                        <RadzenCategoryAxis Formatter="@FormatTimestamp"></RadzenCategoryAxis>
                                        <RadzenValueAxis>
                                            <RadzenGridLines Visible="true" />
                                            <RadzenAxisTitle Text="Pressure (hPa)" />
                                        </RadzenValueAxis>
                                    </RadzenChart>
                                }
                                else
                                {
                                    <p>No pressure trend data available for this period.</p>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
}

@code {
    private TemperatureMeasurement? measurement;
    private WeatherPrediction? prediction;
    private WeatherAnalysisResult? analysisResult;
    private WeatherAnalysisResult? recentAnalysisResult;
    private int analysisPeriod = 7; // Default to 7-day analysis
    private int analysisHours = 1; // Default to 1-hour analysis for recent data
    private bool showShortTermAnalysis = true; // Default to short-term analysis view
    private readonly int deviceOfflineThresholdMinutes = 10; // Consider device offline after 10 minutes of no updates
    private bool isLoading = true;
    private string? cacheStatus;
    private DateTime? nextCacheRefresh;
    private readonly TimeSpan cacheDuration = TimeSpan.FromMinutes(15); // Estimated cache duration

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        
        // Load the prediction data
        await LoadPredictionData();
        
        // Start with short-term (recent) analysis
        await AnalyzeRecentPeriod(analysisHours);
        
        // Also load long-term analysis in background
        await AnalyzePeriod(analysisPeriod);
    }

    private async Task RefreshData()
    {
        isLoading = true;
        StateHasChanged();  // Ensure loading indicator is shown immediately
        
        await LoadData();
        
        // Only refresh the analysis that's currently showing
        if (showShortTermAnalysis)
        {
            await AnalyzeRecentPeriod(analysisHours);
        }
        else 
        {
            await AnalyzePeriod(analysisPeriod);
        }
        
        isLoading = false;
        cacheStatus = "Just updated";
        StateHasChanged();
        
        // Clear the cache status indicator after 5 seconds
        await Task.Delay(5000);
        cacheStatus = null;
        StateHasChanged();
    }

    private async Task RefreshPrediction()
    {
        await LoadPredictionData();
        StateHasChanged();
    }

    private async Task LoadPredictionData()
    {
        try
        {
            prediction = await TemperatureService.GetLatestPredictionAsync();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading prediction data: {ex.Message}");
        }
    }

    private async Task LoadData()
    {
        try
        {
            // Use TemperatureService instead of direct HttpClient call
            measurement = await TemperatureService.GetLatestMeasurementAsync();
            
            // Update the next cache refresh time estimation
            nextCacheRefresh = DateTime.Now.Add(cacheDuration);
            
            isLoading = false;
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading weather data: {ex.Message}");
            isLoading = false;
        }
    }
    
    // New constants for data age thresholds
    private readonly int DATA_FRESH_MINUTES = 60; // Data is considered fresh within 1 hour
    
    // Updated methods to reflect data freshness instead of device online status
    private bool IsDataStale()
    {
        if (measurement == null)
            return true;
            
        // Calculate minutes since last update
        var dataAge = DateTime.Now - measurement.TimestampMs;
        return dataAge.TotalMinutes > DATA_FRESH_MINUTES;
    }
    
    private bool IsDeviceOffline()
    {
        if (measurement == null)
            return true;
            
        // Calculate minutes since last update
        var dataAge = DateTime.Now - measurement.TimestampMs;
        return dataAge.TotalMinutes > deviceOfflineThresholdMinutes;
    }
    
    private string GetDataAge()
    {
        if (measurement == null)
            return "unknown";
            
        var age = DateTime.Now - measurement.TimestampMs;
        if (age.TotalDays > 1)
        {
            return $"{Math.Floor(age.TotalDays)} day(s)";
        }
        else if (age.TotalHours > 1)
        {
            return $"{Math.Floor(age.TotalHours)} hour(s)";
        }
        else 
        {
            return $"{Math.Floor(age.TotalMinutes)} minute(s)";
        }
    }
    
    private string GetTimeUntilCacheRefresh()
    {
        if (!nextCacheRefresh.HasValue)
            return "unknown";
            
        var timeLeft = nextCacheRefresh.Value - DateTime.Now;
        if (timeLeft.TotalSeconds <= 0)
            return "any moment";
            
        if (timeLeft.TotalMinutes < 1)
            return $"{Math.Ceiling(timeLeft.TotalSeconds)} seconds";
        else
            return $"{Math.Ceiling(timeLeft.TotalMinutes)} minutes";
    }
    
    private void SwitchToLongTermAnalysis()
    {
        showShortTermAnalysis = false;
        StateHasChanged();
    }
    
    private void SwitchToShortTermAnalysis()
    {
        showShortTermAnalysis = true;
        StateHasChanged();
    }
    
    private async Task AnalyzePeriod(int days)
    {
        analysisPeriod = days;
        try
        {
            analysisResult = await TemperatureService.GetAnalysisAsync(days);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error analyzing weather over {days} days: {ex.Message}");
        }
        StateHasChanged();
    }
    
    private async Task AnalyzeRecentPeriod(int hours)
    {
        analysisHours = hours;
        try
        {
            recentAnalysisResult = await TemperatureService.GetRecentAnalysisAsync(hours);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error analyzing recent weather over {hours} hours: {ex.Message}");
        }
        StateHasChanged();
    }
    
    private string FormatDouble(double? value)
    {
        if (value == null)
            return "N/A";
            
        return Math.Round(value.Value, 1).ToString("0.0");
    }
    
    private string FormatTemperatureF(double? tempC)
    {
        if (tempC == null)
            return "N/A";
            
        double tempF = 32 + (tempC.Value * 9 / 5);
        return Math.Round(tempF, 1).ToString("0.0");
    }
    
    private string FormatTimestamp(object value)
    {
        if (value is DateTime dt)
        {
            if (showShortTermAnalysis)
            {
                // For short-term (hourly) analysis, show hour and minutes
                return dt.ToString("HH:mm");
            }
            else
            {
                // For long-term analysis, show just the day
                return dt.ToString("MM/dd");
            }
        }
        
        return value?.ToString() ?? "";
    }
}
